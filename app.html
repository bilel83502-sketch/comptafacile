<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Comptabilit√©</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script>
// ===== CONFIGURATION (injected at download) =====
var APP_CONFIG = null;
// ===== END CONFIG =====
</script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Outfit',sans-serif;background:#f5f6fa;color:#1a1a2e;min-height:100vh}
.hd{background:linear-gradient(135deg,#0f172a,#1e293b);color:#fff;padding:14px 24px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100;box-shadow:0 4px 20px rgba(0,0,0,.15)}
.hd-l{display:flex;align-items:center;gap:12px}
.hd-logo{width:38px;height:38px;border-radius:10px;background:linear-gradient(135deg,#3b82f6,#8b5cf6);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:13px}
.hd-t{font-weight:800;font-size:16px}
.hd-s{font-size:10px;opacity:.5;letter-spacing:.8px;text-transform:uppercase}
.yr{background:rgba(255,255,255,.1);color:#fff;border:1px solid rgba(255,255,255,.15);border-radius:8px;padding:6px 12px;font-size:13px;font-family:inherit;outline:none}
.yr option{color:#000}
.nv{display:flex;gap:2px;padding:0 16px;background:#fff;border-bottom:1px solid #e5e7eb;overflow-x:auto;position:sticky;top:66px;z-index:99;-webkit-overflow-scrolling:touch}
.nb{padding:12px 16px;border:none;background:none;cursor:pointer;font-size:12px;font-weight:500;font-family:inherit;color:#888;border-bottom:3px solid transparent;white-space:nowrap;transition:all .15s}
.nb.ac{color:#3b82f6;font-weight:700;border-bottom-color:#3b82f6}
.nbdg{margin-left:5px;background:#ef4444;color:#fff;border-radius:10px;padding:1px 6px;font-size:10px;font-weight:700}
.mn{padding:20px 24px;max-width:1200px;margin:0 auto}
.cd{background:#fff;border-radius:16px;padding:18px 22px;box-shadow:0 2px 16px rgba(0,0,0,.06);border:1px solid #f0f0f0;margin-bottom:12px}
.row{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px}
.st{flex:1;min-width:140px}
.sl{font-size:10px;color:#999;text-transform:uppercase;letter-spacing:.8px;font-weight:600;margin-bottom:2px}
.sv{font-size:22px;font-weight:800}
.ss{font-size:10px;color:#999;margin-top:1px}
.btn{padding:8px 16px;border-radius:10px;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;border:none;display:inline-flex;align-items:center;gap:4px;transition:all .15s}
.btn:hover{opacity:.85}
.btn-p{background:#3b82f6;color:#fff}
.btn-s{background:#f3f4f6;color:#374151;border:1px solid #e5e7eb}
.btn-g{background:#10b981;color:#fff}
.btn-d{background:#ef4444;color:#fff}
.btn-sm{padding:4px 10px;font-size:11px}
.bdg{padding:2px 8px;border-radius:16px;font-size:10px;font-weight:600;display:inline-block;margin-left:4px}
.b-brouillon{background:#e5e7eb;color:#374151}
.b-envoyee{background:#dbeafe;color:#1e40af}
.b-payee{background:#d1fae5;color:#065f46}
.b-en_retard{background:#fee2e2;color:#991b1b}
.b-annulee{background:#fef3c7;color:#92400e}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;display:flex;align-items:center;justify-content:center;padding:16px;backdrop-filter:blur(4px)}
.modal{background:#fff;border-radius:18px;padding:24px;width:100%;max-width:560px;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.2)}
.fg{margin-bottom:10px}
.fl{font-size:11px;font-weight:600;color:#555;display:block;margin-bottom:2px}
.fi,.fsel{width:100%;padding:9px 12px;border-radius:10px;border:1.5px solid #e5e7eb;font-size:13px;outline:none;font-family:inherit;background:#fff;transition:border .15s}
.fi:focus,.fsel:focus{border-color:#3b82f6}
.f2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.factions{display:flex;gap:8px;justify-content:flex-end;margin-top:14px}
.frow{display:flex;gap:4px;flex-wrap:wrap}
.fbtn{padding:5px 12px;border-radius:20px;border:1.5px solid #e5e7eb;background:#fff;color:#666;font-size:11px;font-weight:600;cursor:pointer;font-family:inherit;transition:all .15s}
.fbtn.ac{border-color:#3b82f6;background:rgba(59,130,246,.06);color:#3b82f6}
.lrow{display:flex;gap:5px;margin-bottom:3px;align-items:center}
.linp{padding:7px 10px;border-radius:7px;border:1.5px solid #e5e7eb;font-size:12px;font-family:inherit}
.addl{background:none;border:1.5px dashed #ccc;border-radius:7px;padding:6px;width:100%;cursor:pointer;font-size:11px;color:#888;font-family:inherit;margin-top:2px}
.totbox{background:#f8fafc;border-radius:10px;padding:10px 14px;margin:10px 0}
.cgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px}
.cstat{display:grid;grid-template-columns:1fr 1fr;gap:4px;font-size:10px}
.csbox{background:#f8fafc;padding:5px 7px;border-radius:5px}
.barbg{height:6px;background:#f0f0f0;border-radius:6px}
.barfl{height:100%;border-radius:6px;background:linear-gradient(90deg,#ec4899,#f472b6);transition:width .4s}
.chart{display:flex;align-items:flex-end;gap:3px;height:130px}
.ccol{flex:1;display:flex;flex-direction:column;align-items:center}
.cbars{display:flex;gap:1px;align-items:flex-end;height:105px;width:100%}
.cbar{flex:1;border-radius:2px 2px 0 0;min-width:2px;transition:height .4s}
.clbl{font-size:8px;color:#999;margin-top:1px}
.progbg{height:7px;background:#f0f0f0;border-radius:7px;overflow:hidden}
.progfl{height:100%;border-radius:7px;transition:width .5s}
.tbl{width:100%;border-collapse:collapse;font-size:11px}
.tbl th{text-align:right;padding:6px 8px;font-weight:600;color:#999}
.tbl th:first-child{text-align:left}
.tbl td{padding:6px 8px;text-align:right}
.tbl td:first-child{text-align:left;font-weight:600}
.tbl thead tr{border-bottom:2px solid #eee}
.tbl tbody tr{border-bottom:1px solid #f5f5f5}
.tbl tfoot tr{border-top:2px solid #ddd;font-weight:800}
.prow{display:flex;justify-content:space-between;align-items:center;padding:7px 10px;border-radius:8px;margin-bottom:3px}
.prow.late{background:#fef2f2}
.prow.ok{background:#f8fafc}
.empty{text-align:center;padding:28px;color:#999}
.emptyi{font-size:28px;margin-bottom:4px}
.del{background:none;border:none;cursor:pointer;font-size:13px;color:#ccc}
.del:hover{color:#ef4444}
.warn{background:#fef3c7;border:1px solid #f59e0b;border-radius:10px;padding:8px 14px;margin-bottom:10px;font-size:11px;color:#92400e}
.bkgrid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
.bkcard{padding:20px;text-align:center}
.nocfg{min-height:100vh;display:flex;align-items:center;justify-content:center;background:#0a0f1c;color:#fff;text-align:center;padding:40px}
.nocfg h1{font-size:28px;font-weight:800;margin-bottom:12px}
.nocfg p{color:#94a3b8;max-width:400px;line-height:1.6}
@media(max-width:768px){.hd{padding:12px 14px}.mn{padding:14px}.f2{grid-template-columns:1fr}.nb{padding:10px 12px;font-size:11px}.cgrid{grid-template-columns:1fr}.bkgrid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div id="app"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script type="text/babel">
const {useState, useEffect, useMemo, useRef} = React;

// Check config
if (!APP_CONFIG) {
  ReactDOM.createRoot(document.getElementById("app")).render(
    <div className="nocfg">
      <div>
        <div style={{fontSize:64,marginBottom:20}}>üìä</div>
        <h1>ComptaFacile</h1>
        <p>Ce fichier n'a pas √©t√© configur√©. Rendez-vous sur le site ComptaFacile pour g√©n√©rer votre outil personnalis√©.</p>
      </div>
    </div>
  );
} else {

const CFG = APP_CONFIG;
const STATUTS={
  micro_service:{label:"Micro (Services)",charges:.221,tvaSeuil:36800,tva:.20,hasIS:false},
  micro_commerce:{label:"Micro (Commerce)",charges:.123,tvaSeuil:91900,tva:.20,hasIS:false},
  micro_liberal:{label:"Micro (Lib√©ral)",charges:.211,tvaSeuil:36800,tva:.20,hasIS:false},
  ei:{label:"EI",charges:.45,tvaSeuil:36800,tva:.20,hasIS:false},
  eurl_ir:{label:"EURL (IR)",charges:.45,tvaSeuil:0,tva:.20,hasIS:false},
  eurl_is:{label:"EURL (IS)",charges:.45,tvaSeuil:0,tva:.20,hasIS:true,is1:.15,isSeuil:42500,is2:.25},
  sarl:{label:"SARL",charges:.45,tvaSeuil:0,tva:.20,hasIS:true,is1:.15,isSeuil:42500,is2:.25},
  sasu:{label:"SASU",charges:.78,tvaSeuil:0,tva:.20,hasIS:true,is1:.15,isSeuil:42500,is2:.25},
  sas:{label:"SAS",charges:.78,tvaSeuil:0,tva:.20,hasIS:true,is1:.15,isSeuil:42500,is2:.25},
};
const SECTEURS={
  btp:{label:"BTP",cats:["Mat√©riaux","Outillage","Location engins","Sous-traitance","EPI & S√©curit√©","Transport","Assurance d√©cennale","Carburant","T√©l√©phone","Autre"]},
  transport:{label:"Transport",cats:["Carburant","P√©ages","Entretien v√©hicule","Assurance v√©hicule","Location v√©hicule","Stationnement","T√©l√©phone","Repas route","Autre"]},
  commerce:{label:"Commerce",cats:["Stock & Marchandises","Emballages","Frais de port","Local & Loyer","Publicit√©","Assurance","T√©l√©phone","Logiciel caisse","Autre"]},
  service:{label:"Services",cats:["D√©placement","Logiciel & Abo","T√©l√©phone & Internet","Formation","Fournitures bureau","Assurance RC Pro","Repas","Sous-traitance","Autre"]},
  tech:{label:"Tech",cats:["H√©bergement & Cloud","Logiciels & Licences","Mat√©riel info","Coworking","Formation","T√©l√©phone & Internet","Sous-traitance","Publicit√©","Autre"]},
  restauration:{label:"Restauration",cats:["Mati√®res premi√®res","Produits entretien","√âquipement cuisine","Loyer","√ânergie","Consommables","Assurance","Publicit√©","Autre"]},
  sante:{label:"Sant√©",cats:["Mat√©riel m√©dical","Consommables","Local & Loyer","Assurance RC Pro","Formation continue","Logiciel cabinet","T√©l√©phone","Autre"]},
  artisanat:{label:"Artisanat",cats:["Mati√®res premi√®res","Outillage","Emballages","Frais de port","Atelier & Local","March√©s & Salons","Assurance","Autre"]},
  immobilier:{label:"Immobilier",cats:["Travaux","Assurance PNO","Taxe fonci√®re","Frais de gestion","Charges copro","Int√©r√™ts emprunt","Diagnostics","Autre"]},
  autre:{label:"Autre",cats:["Fournitures","D√©placement","Logiciel","T√©l√©phone","Assurance","Formation","Sous-traitance","Repas","Loyer","Autre"]},
};

const S = STATUTS[CFG.statut] || STATUTS.micro_service;
const SEC = SECTEURS[CFG.secteur] || SECTEURS.autre;
const CATS = SEC.cats;
const chR = S.charges;
const tvaSeuil = S.tvaSeuil || 0;
const tvaR = S.tva || 0.20;
const isMicro = CFG.statut && CFG.statut.indexOf("micro") === 0;
const chLabel = isMicro ? "URSSAF" : (CFG.statut==="sasu"||CFG.statut==="sas" ? "Charges (assimil√© salari√©)" : "Charges sociales (TNS)");
const initials = CFG.name ? CFG.name.slice(0,2).toUpperCase() : "CF";

document.title = CFG.name + " ‚Äî Comptabilit√©";

const MS=["Jan","F√©v","Mar","Avr","Mai","Jun","Jul","Ao√ª","Sep","Oct","Nov","D√©c"];
const SL={brouillon:"Brouillon",envoyee:"Envoy√©e",payee:"Pay√©e",en_retard:"En retard",annulee:"Annul√©e"};
const uid=()=>Math.random().toString(36).slice(2,10);
const fmt=n=>new Intl.NumberFormat("fr-FR",{style:"currency",currency:"EUR"}).format(n);
const fD=d=>new Date(d).toLocaleDateString("fr-FR");
const td=()=>new Date().toISOString().slice(0,10);
const addBD=(date,days)=>{const d=new Date(date);let a=0;while(a<days){d.setDate(d.getDate()+1);if(d.getDay()!==0&&d.getDay()!==6)a++;}return d.toISOString().slice(0,10);};
const dD=(a,b)=>Math.ceil((new Date(b)-new Date(a))/864e5);
const pc=(n,t)=>t>0?Math.round(n/t*100):0;
function ld(k,f){try{return JSON.parse(localStorage.getItem(k))||f;}catch{return f;}}
function sv(k,d){localStorage.setItem(k,JSON.stringify(d));}

function Bdg({s}){return <span className={"bdg b-"+s}>{SL[s]||s}</span>;}
function Modal({open,onClose,title,children}){
  if(!open) return null;
  return(<div className="overlay" onClick={onClose}><div className="modal" onClick={e=>e.stopPropagation()}><div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14}}><h3 style={{fontSize:17,fontWeight:700}}>{title}</h3><button onClick={onClose} style={{background:"none",border:"none",fontSize:18,cursor:"pointer",color:"#999"}}>‚úï</button></div>{children}</div></div>);
}

function App(){
  const [tab,setTab]=useState("dash");
  const [inv,setInv]=useState(()=>ld("cf_inv",[]));
  const [exp,setExp]=useState(()=>ld("cf_exp",[]));
  const [cli,setCli]=useState(()=>ld("cf_cli",[]));
  const [yr,setYr]=useState(new Date().getFullYear());

  useEffect(()=>{sv("cf_inv",inv);},[inv]);
  useEffect(()=>{sv("cf_exp",exp);},[exp]);
  useEffect(()=>{sv("cf_cli",cli);},[cli]);
  useEffect(()=>{const n=td();setInv(p=>p.map(i=>i.status==="envoyee"&&i.ech&&i.ech<n?{...i,status:"en_retard"}:i));},[tab]);

  const yI=useMemo(()=>inv.filter(i=>i.date&&i.date.startsWith(String(yr))),[inv,yr]);
  const yE=useMemo(()=>exp.filter(e=>e.date&&e.date.startsWith(String(yr))),[exp,yr]);
  const caHT=useMemo(()=>yI.filter(i=>i.status!=="annulee").reduce((s,i)=>s+(i.ht||0),0),[yI]);
  const caE=useMemo(()=>yI.filter(i=>i.status==="payee").reduce((s,i)=>s+(i.ht||0),0),[yI]);
  const tD=useMemo(()=>yE.reduce((s,e)=>s+(e.mt||0),0),[yE]);
  const ch=caHT*chR; const ben=caE-tD-(caE*chR);
  const tvaAct=tvaSeuil>0?caHT>tvaSeuil:true;
  const enA=useMemo(()=>yI.filter(i=>i.status==="envoyee"||i.status==="en_retard").reduce((s,i)=>s+(i.ht||0),0),[yI]);
  const nR=useMemo(()=>inv.filter(i=>i.status==="en_retard").length,[inv]);
  const pTVA=tvaSeuil>0?Math.min((caHT/tvaSeuil)*100,100):100;
  let isAmt=0; if(S.hasIS){const pr=caHT-tD;if(pr>0)isAmt=pr<=(S.isSeuil||42500)?pr*(S.is1||.15):(S.isSeuil||42500)*(S.is1||.15)+(pr-(S.isSeuil||42500))*(S.is2||.25);}

  const mC=useMemo(()=>{const m=Array(12).fill(0);yI.filter(i=>i.status!=="annulee").forEach(i=>{m[new Date(i.date).getMonth()]+=i.ht||0;});return m;},[yI]);
  const mE=useMemo(()=>{const m=Array(12).fill(0);yE.forEach(e=>{m[new Date(e.date).getMonth()]+=e.mt||0;});return m;},[yE]);
  const mx=Math.max(...mC,...mE,1);
  const up=useMemo(()=>inv.filter(i=>i.status==="envoyee"||i.status==="en_retard").sort((a,b)=>(a.ech||"").localeCompare(b.ech||"")).slice(0,5),[inv]);

  // Factures
  const [fSh,fSSh]=useState(false);const [fEId,fSEId]=useState(null);const [fFi,fSFi]=useState("toutes");
  const fInit={client:"",lignes:[{d:"",q:1,p:0}],delai:"30",date:td(),tva:false};
  const [fF,fSF]=useState(fInit);
  const fNew=()=>{fSF({...fInit,tva:tvaAct});fSEId(null);fSSh(true);};
  const fEdit=i=>{fSF({client:i.client,lignes:i.lignes||[{d:"",q:1,p:i.ht}],delai:String(i.dj||30),date:i.date,tva:i.tvA||false});fSEId(i.id);fSSh(true);};
  const fSave=()=>{const ht=fF.lignes.reduce((s,l)=>s+l.q*l.p,0);const tv=fF.tva?ht*tvaR:0;const ttc=ht+tv;const dj=parseInt(fF.delai)||30;const ech=addBD(fF.date,dj);if(fEId){setInv(p=>p.map(i=>i.id===fEId?{...i,client:fF.client,lignes:fF.lignes,ht,tv,ttc,tvA:fF.tva,date:fF.date,dj,ech}:i));}else{setInv(p=>[...p,{id:uid(),num:"FAC-"+String(inv.length+1).padStart(4,"0"),client:fF.client,lignes:fF.lignes,ht,tv,ttc,tvA:fF.tva,date:fF.date,dj,ech,status:"brouillon",dp:null}]);}fSSh(false);};
  const fStatus=(id,st)=>setInv(p=>p.map(i=>i.id===id?{...i,status:st,dp:st==="payee"?td():i.dp}:i));
  const fDel=id=>{if(confirm("Supprimer ?"))setInv(p=>p.filter(i=>i.id!==id));};
  const fList=fFi==="toutes"?inv:inv.filter(i=>i.status===fFi);
  const fHT=fF.lignes.reduce((s,l)=>s+l.q*l.p,0);const fTV=fF.tva?fHT*tvaR:0;
  const fAddL=()=>fSF(f=>({...f,lignes:[...f.lignes,{d:"",q:1,p:0}]}));
  const fRemL=i=>fSF(f=>({...f,lignes:f.lignes.filter((_,j)=>j!==i)}));
  const fUpL=(i,k,v)=>fSF(f=>({...f,lignes:f.lignes.map((l,j)=>j===i?{...l,[k]:v}:l)}));

  // D√©penses
  const [dSh,dSSh]=useState(false);
  const [dF,dSF]=useState({desc:"",mt:"",cat:CATS[0],date:td()});
  const dSave=()=>{setExp(p=>[...p,{id:uid(),desc:dF.desc,mt:Number(dF.mt),cat:dF.cat,date:dF.date}]);dSSh(false);dSF({desc:"",mt:"",cat:CATS[0],date:td()});};
  const dDel=id=>{if(confirm("Supprimer ?"))setExp(p=>p.filter(e=>e.id!==id));};
  const byCat=useMemo(()=>{const m={};exp.forEach(e=>{m[e.cat]=(m[e.cat]||0)+e.mt;});return Object.entries(m).sort((a,b)=>b[1]-a[1]);},[exp]);
  const totE=exp.reduce((s,e)=>s+e.mt,0);const mxCat=byCat.length>0?byCat[0][1]:1;

  // Clients
  const [cSh,cSSh]=useState(false);const [cF,cSF]=useState({nom:"",email:"",tel:""});
  const cSave=()=>{setCli(p=>[...p,{id:uid(),...cF}]);cSSh(false);cSF({nom:"",email:"",tel:""});};
  const cDel=id=>{if(confirm("Supprimer ?"))setCli(p=>p.filter(c=>c.id!==id));};
  const cStats=useMemo(()=>{const m={};cli.forEach(c=>{const ci=inv.filter(i=>i.client===c.nom);m[c.id]={t:ci.filter(i=>i.status!=="annulee").reduce((s,i)=>s+(i.ht||0),0),p:ci.filter(i=>i.status==="envoyee"||i.status==="en_retard").reduce((s,i)=>s+(i.ht||0),0)};});return m;},[cli,inv]);

  // Tr√©sorerie
  const paid=yI.filter(i=>i.status==="payee");
  const unpaid=inv.filter(i=>i.status==="envoyee"||i.status==="en_retard");
  const mCF=useMemo(()=>MS.map((m,i)=>{const inc=paid.filter(x=>new Date(x.dp||x.date).getMonth()===i).reduce((s,x)=>s+(x.ht||0),0);const ex=yE.filter(e=>new Date(e.date).getMonth()===i).reduce((s,e)=>s+(e.mt||0),0);return{m,inc,ex,net:inc-ex};}),[paid,yE]);

  // Backup
  const bRef=useRef(null);const [bMsg,bSMsg]=useState(null);
  const bExport=()=>{const d={v:"2.0",app:"ComptaFacile",config:CFG,data:{invoices:inv,expenses:exp,clients:cli}};const b=new Blob([JSON.stringify(d,null,2)],{type:"application/json"});const a=document.createElement("a");a.href=URL.createObjectURL(b);a.download="sauvegarde-"+CFG.name.replace(/\s/g,"-")+"-"+td().replace(/-/g,"")+".json";document.body.appendChild(a);a.click();document.body.removeChild(a);bSMsg("ok");setTimeout(()=>bSMsg(null),4000);};
  const bImport=e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{try{const d=JSON.parse(ev.target.result);if(!d.data)throw"";if(!confirm("Restaurer ?"))return;setInv(d.data.invoices||[]);setExp(d.data.expenses||[]);setCli(d.data.clients||[]);bSMsg("ok");}catch{bSMsg("err");}setTimeout(()=>bSMsg(null),4000);};r.readAsText(f);e.target.value="";};

  const TABS=[{id:"dash",l:"Dashboard",i:"üìä"},{id:"fac",l:"Factures",i:"üìÑ"},{id:"dep",l:"D√©penses",i:"üí∏"},{id:"cli",l:"Clients",i:"üë•"},{id:"tre",l:"Tr√©sorerie",i:"üè¶"},{id:"bak",l:"Sauvegarde",i:"üíæ"}];

  return(<div>
    <header className="hd"><div className="hd-l"><div className="hd-logo">{initials}</div><div><div className="hd-t">{CFG.name}</div><div className="hd-s">{S.label} ‚Ä¢ {SEC.label}</div></div></div><div><select className="yr" value={yr} onChange={e=>setYr(Number(e.target.value))}>{[2024,2025,2026,2027].map(y=><option key={y}>{y}</option>)}</select></div></header>
    <nav className="nv">{TABS.map(t=>(<button key={t.id} className={"nb"+(tab===t.id?" ac":"")} onClick={()=>setTab(t.id)}>{t.i} {t.l}{t.id==="fac"&&nR>0&&<span className="nbdg">{nR}</span>}</button>))}</nav>
    <main className="mn">

    {/* ‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê */}
    {tab==="dash"&&<div>
      <div className="row">
        <div className="cd st"><div className="sl">CA Factur√©</div><div className="sv" style={{color:"#3b82f6"}}>{fmt(caHT)}</div><div className="ss">{yI.length} facture(s)</div></div>
        <div className="cd st"><div className="sl">Encaiss√©</div><div className="sv" style={{color:"#10b981"}}>{fmt(caE)}</div></div>
        <div className="cd st"><div className="sl">En attente</div><div className="sv" style={{color:nR>0?"#ef4444":"#f59e0b"}}>{fmt(enA)}</div><div className="ss">{nR>0?`‚ö†Ô∏è ${nR} retard`:"OK"}</div></div>
        <div className="cd st"><div className="sl">D√©penses</div><div className="sv" style={{color:"#ec4899"}}>{fmt(tD)}</div></div>
      </div>
      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12,marginBottom:16}}>
        <div className="cd"><div className="sl">{chLabel} ({Math.round(chR*100)}%)</div><div style={{fontSize:20,fontWeight:800,color:"#ec4899",margin:"3px 0"}}>{fmt(ch)}</div>{S.hasIS&&<div style={{fontSize:10,color:"#8b5cf6",fontWeight:600}}>IS: {fmt(isAmt)}</div>}<div style={{marginTop:6,fontSize:13,fontWeight:700,color:ben>=0?"#10b981":"#ef4444"}}>Net: {fmt(ben)}</div></div>
        {tvaSeuil>0 ? <div className="cd"><div className="sl">Seuil TVA {tvaAct?"‚ö†Ô∏è D√âPASS√â":""}</div><div style={{display:"flex",justifyContent:"space-between",margin:"3px 0 5px"}}><span style={{fontSize:16,fontWeight:800,color:tvaAct?"#ef4444":"#3b82f6"}}>{fmt(caHT)}</span><span style={{fontSize:10,color:"#999"}}>/ {fmt(tvaSeuil)}</span></div><div className="progbg"><div className="progfl" style={{width:pTVA+"%",background:tvaAct?"#ef4444":"linear-gradient(90deg,#3b82f6,#8b5cf6)"}}/></div></div>
        : <div className="cd"><div className="sl">TVA collect√©e</div><div style={{fontSize:16,fontWeight:800,color:"#8b5cf6"}}>{fmt(caHT*0.2)}</div></div>}
      </div>
      <div className="cd" style={{marginBottom:16}}><div style={{fontSize:11,fontWeight:700,marginBottom:12}}>Revenus vs D√©penses ‚Äî {yr}</div><div className="chart">{MS.map((m,i)=>(<div key={m} className="ccol"><div className="cbars"><div className="cbar" style={{background:"linear-gradient(180deg,#3b82f6,#8b5cf6)",height:(mC[i]/mx)*100+"%",minHeight:mC[i]>0?2:0}}/><div className="cbar" style={{background:"linear-gradient(180deg,#f87171,#ec4899)",height:(mE[i]/mx)*100+"%",minHeight:mE[i]>0?2:0}}/></div><div className="clbl">{m}</div></div>))}</div></div>
      {up.length>0&&<div className="cd"><div style={{fontSize:11,fontWeight:700,marginBottom:8}}>En attente</div>{up.map(i=>{const dl=dD(td(),i.ech);return(<div key={i.id} className={"prow "+(dl<0?"late":"ok")}><div><div style={{fontWeight:600,fontSize:11}}>{i.num} ‚Äî {i.client}</div><div style={{fontSize:9,color:"#999"}}>√âch. {fD(i.ech)}</div></div><div style={{textAlign:"right"}}><div style={{fontWeight:700,fontSize:12}}>{fmt(i.ht)}</div><div style={{fontSize:8,color:dl<0?"#ef4444":"#999"}}>{dl<0?Math.abs(dl)+"j retard":dl+"j"}</div></div></div>);})}</div>}
    </div>}

    {/* ‚ïê‚ïê‚ïê FACTURES ‚ïê‚ïê‚ïê */}
    {tab==="fac"&&<div>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12,flexWrap:"wrap",gap:6}}>
        <div className="frow">{["toutes","brouillon","envoyee","payee","en_retard","annulee"].map(f=>(<button key={f} className={"fbtn"+(fFi===f?" ac":"")} onClick={()=>fSFi(f)}>{f==="toutes"?"Toutes":SL[f]}</button>))}</div>
        <button className="btn btn-p" onClick={fNew}>+ Facture</button>
      </div>
      {tvaAct&&tvaSeuil>0&&<div className="warn">‚ö†Ô∏è Seuil TVA d√©pass√© ‚Äî facturez la TVA ({Math.round(tvaR*100)}%)</div>}
      {fList.length===0?<div className="cd empty"><div className="emptyi">üìÑ</div>Aucune facture</div>:
        fList.sort((a,b)=>(b.date||"").localeCompare(a.date||"")).map(i=>(
          <div key={i.id} className="cd" style={{padding:"10px 16px",marginBottom:6}}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap",gap:4}}>
              <div style={{flex:1,minWidth:140}}>
                <div><span style={{fontWeight:800,fontSize:12}}>{i.num}</span><Bdg s={i.status}/></div>
                <div style={{fontSize:10,color:"#666"}}>{i.client}</div>
                <div style={{fontSize:9,color:"#999"}}>{fD(i.date)} ‚Ä¢ {i.dj}j ‚Ä¢ √âch. {fD(i.ech)}{i.tvA?" ‚Ä¢ TVA":""}</div>
              </div>
              <div style={{textAlign:"right"}}><div style={{fontSize:16,fontWeight:800}}>{fmt(i.ttc||i.ht)}</div>{i.tvA&&<div style={{fontSize:8,color:"#999"}}>HT: {fmt(i.ht)}</div>}</div>
            </div>
            <div style={{display:"flex",gap:3,marginTop:6,flexWrap:"wrap"}}>
              {i.status==="brouillon"&&<button className="btn btn-s btn-sm" onClick={()=>fStatus(i.id,"envoyee")}>üì§ Envoy√©e</button>}
              {(i.status==="envoyee"||i.status==="en_retard")&&<button className="btn btn-g btn-sm" onClick={()=>fStatus(i.id,"payee")}>‚úÖ Pay√©e</button>}
              {i.status!=="annulee"&&i.status!=="payee"&&<button className="btn btn-s btn-sm" onClick={()=>fStatus(i.id,"annulee")}>üö´</button>}
              <button className="btn btn-s btn-sm" onClick={()=>fEdit(i)}>‚úèÔ∏è</button>
              <button className="btn btn-d btn-sm" onClick={()=>fDel(i.id)}>üóë</button>
            </div>
          </div>
        ))
      }
      <Modal open={fSh} onClose={()=>fSSh(false)} title={fEId?"Modifier":"Nouvelle facture"}>
        <div className="f2">
          <div className="fg">{cli.length>0?<><label className="fl">Client</label><select className="fsel" value={fF.client} onChange={e=>fSF(f=>({...f,client:e.target.value}))}><option value="">‚Äî</option>{cli.map(c=><option key={c.id} value={c.nom}>{c.nom}</option>)}</select></>:<><label className="fl">Client</label><input className="fi" value={fF.client} onChange={e=>fSF(f=>({...f,client:e.target.value}))}/></>}</div>
          <div className="fg"><label className="fl">Date</label><input className="fi" type="date" value={fF.date} onChange={e=>fSF(f=>({...f,date:e.target.value}))}/></div>
        </div>
        <div className="f2">
          <div className="fg"><label className="fl">D√©lai</label><select className="fsel" value={fF.delai} onChange={e=>fSF(f=>({...f,delai:e.target.value}))}><option value="0">Comptant</option><option value="15">15j</option><option value="30">30j</option><option value="45">45j</option><option value="60">60j</option></select></div>
          <div style={{display:"flex",alignItems:"center",gap:5,paddingTop:16}}><input type="checkbox" checked={fF.tva} onChange={e=>fSF(f=>({...f,tva:e.target.checked}))}/><span style={{fontSize:11,fontWeight:600}}>TVA {Math.round(tvaR*100)}%</span></div>
        </div>
        <div className="fg"><label className="fl">Lignes</label>
          {fF.lignes.map((l,i)=>(
            <div key={i} className="lrow">
              <input className="linp" style={{flex:3}} placeholder="Description" value={l.d} onChange={e=>fUpL(i,"d",e.target.value)}/>
              <input className="linp" style={{flex:1,textAlign:"center"}} type="number" value={l.q} onChange={e=>fUpL(i,"q",Number(e.target.value))} min="1"/>
              <input className="linp" style={{flex:1,textAlign:"right"}} type="number" placeholder="P.U." value={l.p||""} onChange={e=>fUpL(i,"p",Number(e.target.value))} min="0" step=".01"/>
              <span style={{flex:1,fontSize:10,fontWeight:700,textAlign:"right"}}>{fmt(l.q*l.p)}</span>
              {fF.lignes.length>1&&<button style={{background:"none",border:"none",color:"#ef4444",cursor:"pointer"}} onClick={()=>fRemL(i)}>‚úï</button>}
            </div>
          ))}
          <button className="addl" onClick={fAddL}>+ Ligne</button>
        </div>
        <div className="totbox">
          <div style={{display:"flex",justifyContent:"space-between",fontSize:11}}><span>HT</span><span style={{fontWeight:700}}>{fmt(fHT)}</span></div>
          {fF.tva&&<div style={{display:"flex",justifyContent:"space-between",fontSize:11}}><span>TVA</span><span style={{fontWeight:700}}>{fmt(fTV)}</span></div>}
          <div style={{display:"flex",justifyContent:"space-between",fontSize:14,fontWeight:800,marginTop:4,paddingTop:4,borderTop:"1px solid #e5e7eb"}}><span>TTC</span><span>{fmt(fHT+fTV)}</span></div>
        </div>
        <div className="factions"><button className="btn btn-s" onClick={()=>fSSh(false)}>Annuler</button><button className="btn btn-p" onClick={fSave} disabled={!fF.client||fHT<=0}>Enregistrer</button></div>
      </Modal>
    </div>}

    {/* ‚ïê‚ïê‚ïê DEPENSES ‚ïê‚ïê‚ïê */}
    {tab==="dep"&&<div>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12}}>
        <div style={{fontSize:10,color:"#999"}}>Total: <strong style={{color:"#ec4899",fontSize:14}}>{fmt(totE)}</strong></div>
        <button className="btn btn-p" onClick={()=>dSSh(true)}>+ D√©pense</button>
      </div>
      {byCat.length>0&&<div className="cd" style={{marginBottom:12}}><div style={{fontSize:11,fontWeight:700,marginBottom:8}}>Par cat√©gorie</div>{byCat.map(([c,v])=>(<div key={c} style={{marginBottom:5}}><div style={{display:"flex",justifyContent:"space-between",fontSize:10,marginBottom:1}}><span style={{fontWeight:600}}>{c}</span><span style={{color:"#666"}}>{fmt(v)} ({pc(v,totE)}%)</span></div><div className="barbg"><div className="barfl" style={{width:(v/mxCat)*100+"%"}}/></div></div>))}</div>}
      {exp.length===0?<div className="cd empty"><div className="emptyi">üí∏</div>Aucune d√©pense</div>:
        exp.sort((a,b)=>(b.date||"").localeCompare(a.date||"")).map(e=>(
          <div key={e.id} className="cd" style={{padding:"8px 14px",marginBottom:4}}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
              <div><div style={{fontWeight:700,fontSize:11}}>{e.desc}</div><div style={{fontSize:9,color:"#999"}}>{fD(e.date)} ‚Ä¢ {e.cat}</div></div>
              <div style={{display:"flex",alignItems:"center",gap:6}}><span style={{fontWeight:800,fontSize:12,color:"#ec4899"}}>-{fmt(e.mt)}</span><button className="del" onClick={()=>dDel(e.id)}>üóë</button></div>
            </div>
          </div>
        ))
      }
      <Modal open={dSh} onClose={()=>dSSh(false)} title="Nouvelle d√©pense">
        <div className="fg"><label className="fl">Description</label><input className="fi" value={dF.desc} onChange={e=>dSF(f=>({...f,desc:e.target.value}))}/></div>
        <div className="f2"><div className="fg"><label className="fl">Montant ‚Ç¨</label><input className="fi" type="number" value={dF.mt} onChange={e=>dSF(f=>({...f,mt:e.target.value}))} min="0" step=".01"/></div><div className="fg"><label className="fl">Date</label><input className="fi" type="date" value={dF.date} onChange={e=>dSF(f=>({...f,date:e.target.value}))}/></div></div>
        <div className="fg"><label className="fl">Cat√©gorie</label><select className="fsel" value={dF.cat} onChange={e=>dSF(f=>({...f,cat:e.target.value}))}>{CATS.map(c=><option key={c}>{c}</option>)}</select></div>
        <div className="factions"><button className="btn btn-s" onClick={()=>dSSh(false)}>Annuler</button><button className="btn btn-p" onClick={dSave} disabled={!dF.desc||!dF.mt}>Enregistrer</button></div>
      </Modal>
    </div>}

    {/* ‚ïê‚ïê‚ïê CLIENTS ‚ïê‚ïê‚ïê */}
    {tab==="cli"&&<div>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12}}><span style={{fontSize:10,color:"#999"}}>{cli.length} client(s)</span><button className="btn btn-p" onClick={()=>cSSh(true)}>+ Client</button></div>
      {cli.length===0?<div className="cd empty"><div className="emptyi">üë•</div>Aucun client</div>:
        <div className="cgrid">{cli.map(c=>{const cs=cStats[c.id]||{};return(
          <div key={c.id} className="cd">
            <div style={{display:"flex",justifyContent:"space-between",marginBottom:4}}>
              <div><div style={{fontWeight:800,fontSize:13}}>{c.nom}</div>{c.email&&<div style={{fontSize:9,color:"#999"}}>{c.email}</div>}</div>
              <button className="del" onClick={()=>cDel(c.id)}>üóë</button>
            </div>
            <div className="cstat"><div className="csbox"><div style={{color:"#999",fontSize:8}}>Factur√©</div><div style={{fontWeight:700,fontSize:11,color:"#3b82f6"}}>{fmt(cs.t||0)}</div></div><div className="csbox"><div style={{color:"#999",fontSize:8}}>Attente</div><div style={{fontWeight:700,fontSize:11,color:"#f59e0b"}}>{fmt(cs.p||0)}</div></div></div>
          </div>);})}</div>
      }
      <Modal open={cSh} onClose={()=>cSSh(false)} title="Nouveau client">
        <div className="fg"><label className="fl">Nom / Entreprise</label><input className="fi" value={cF.nom} onChange={e=>cSF(f=>({...f,nom:e.target.value}))}/></div>
        <div className="f2"><div className="fg"><label className="fl">Email</label><input className="fi" value={cF.email} onChange={e=>cSF(f=>({...f,email:e.target.value}))}/></div><div className="fg"><label className="fl">T√©l</label><input className="fi" value={cF.tel} onChange={e=>cSF(f=>({...f,tel:e.target.value}))}/></div></div>
        <div className="factions"><button className="btn btn-s" onClick={()=>cSSh(false)}>Annuler</button><button className="btn btn-p" onClick={cSave} disabled={!cF.nom}>Enregistrer</button></div>
      </Modal>
    </div>}

    {/* ‚ïê‚ïê‚ïê TRESORERIE ‚ïê‚ïê‚ïê */}
    {tab==="tre"&&<div>
      <div className="row">
        <div className="cd st"><div className="sl">Encaiss√©</div><div className="sv" style={{color:"#10b981"}}>{fmt(caE)}</div></div>
        <div className="cd st"><div className="sl">Attente</div><div className="sv" style={{color:"#f59e0b"}}>{fmt(enA)}</div></div>
        <div className="cd st"><div className="sl">D√©penses</div><div className="sv" style={{color:"#ec4899"}}>{fmt(tD)}</div></div>
        <div className="cd st"><div className="sl">{chLabel}</div><div className="sv" style={{color:"#8b5cf6"}}>{fmt(ch)}</div></div>
      </div>
      <div className="cd" style={{textAlign:"center",marginBottom:16,padding:18,background:ben>=0?"linear-gradient(135deg,#d1fae5,#a7f3d0)":"linear-gradient(135deg,#fee2e2,#fecaca)"}}>
        <div style={{fontSize:10,fontWeight:700,textTransform:"uppercase",letterSpacing:1,color:ben>=0?"#065f46":"#991b1b"}}>R√©sultat net</div>
        <div style={{fontSize:26,fontWeight:800,color:ben>=0?"#065f46":"#991b1b"}}>{fmt(ben)}</div>
      </div>
      <div className="cd" style={{marginBottom:16}}><div style={{fontSize:11,fontWeight:700,marginBottom:8}}>Flux mensuel</div><table className="tbl"><thead><tr><th style={{textAlign:"left"}}>Mois</th><th style={{color:"#10b981"}}>Entr√©es</th><th style={{color:"#ec4899"}}>Sorties</th><th>Net</th></tr></thead><tbody>{mCF.map((r,i)=>(<tr key={i}><td>{r.m}</td><td style={{color:"#10b981",fontWeight:600}}>{r.inc>0?fmt(r.inc):"‚Äî"}</td><td style={{color:"#ec4899",fontWeight:600}}>{r.ex>0?fmt(r.ex):"‚Äî"}</td><td style={{fontWeight:700,color:r.net>=0?"#10b981":"#ef4444"}}>{r.inc||r.ex?fmt(r.net):"‚Äî"}</td></tr>))}</tbody></table></div>
      {unpaid.length>0&&<div className="cd"><div style={{fontSize:11,fontWeight:700,marginBottom:8}}>Cr√©ances</div>{unpaid.sort((a,b)=>(a.ech||"").localeCompare(b.ech||"")).map(i=>{const dl=dD(td(),i.ech);return(<div key={i.id} className={"prow "+(dl<0?"late":"ok")}><div><span style={{fontWeight:700,fontSize:11}}>{i.num}</span> <span style={{color:"#666",fontSize:10}}>{i.client}</span><Bdg s={i.status}/></div><div style={{textAlign:"right"}}><div style={{fontWeight:700,fontSize:11}}>{fmt(i.ht)}</div><div style={{fontSize:8,color:dl<0?"#ef4444":"#999"}}>{dl<0?Math.abs(dl)+"j retard":fD(i.ech)}</div></div></div>);})}</div>}
    </div>}

    {/* ‚ïê‚ïê‚ïê SAUVEGARDE ‚ïê‚ïê‚ïê */}
    {tab==="bak"&&<div>
      <div className="bkgrid">
        <div className="cd bkcard"><div style={{fontSize:32,marginBottom:6}}>üíæ</div><div style={{fontSize:14,fontWeight:800,marginBottom:8}}>Exporter</div><button className="btn btn-p" onClick={bExport} style={{width:"100%",justifyContent:"center"}}>‚¨áÔ∏è Sauvegarder</button></div>
        <div className="cd bkcard"><div style={{fontSize:32,marginBottom:6}}>üìÇ</div><div style={{fontSize:14,fontWeight:800,marginBottom:8}}>Restaurer</div><input type="file" accept=".json" style={{display:"none"}} ref={bRef} onChange={bImport}/><button className="btn btn-g" onClick={()=>bRef.current.click()} style={{width:"100%",justifyContent:"center"}}>‚¨ÜÔ∏è Charger</button></div>
      </div>
      {bMsg&&<div style={{background:bMsg==="ok"?"#d1fae5":"#fee2e2",color:bMsg==="ok"?"#065f46":"#991b1b",padding:"7px 12px",borderRadius:8,fontSize:11,fontWeight:600,marginBottom:10}}>{bMsg==="ok"?"Op√©ration r√©ussie ‚úÖ":"Fichier invalide"}</div>}
      <div className="cd">
        <div style={{fontSize:12,fontWeight:700,marginBottom:8}}>Informations</div>
        {[["Entreprise",CFG.name],["Statut",S.label],["Secteur",SEC.label],["Donn√©es",inv.length+" factures ‚Ä¢ "+exp.length+" d√©penses ‚Ä¢ "+cli.length+" clients"]].map(([l,v])=>(
          <div key={l} style={{display:"flex",justifyContent:"space-between",padding:"5px 8px",background:"#f8fafc",borderRadius:6,fontSize:10,marginBottom:2}}><span style={{color:"#666"}}>{l}</span><span style={{fontWeight:700}}>{v}</span></div>
        ))}
      </div>
    </div>}

    </main>
  </div>);
}

ReactDOM.createRoot(document.getElementById("app")).render(<App/>);
} // end of APP_CONFIG check
</script>
</body>
</html>
